# Lab 10: tcpdump Protocol Analyzer

## Purpose
This lab exercise is designed to deepen your understanding of TCP communication, specifically focusing on the opening and closing phases of TCP connections. You will use the `tcpdump` utility to capture network traffic and analyze it in `Wireshark`. The lab emphasizes understanding key TCP fields like **Seq**, **Ack**, and **Win**.

---

## Steps Involved
1. Familiarize yourself with the `tcpdump` utility.
2. Use `tcpdump` to capture network packets during communication.
3. Analyze the captured `.pcap` file using `Wireshark`.
4. Answer questions about captured packets to reinforce learning.

---

## **Exercise 1: Familiarization with tcpdump**

### **Objective**
Understand how to use `tcpdump` to capture and display network packets in a Linux environment.

### **Steps**
1. Open a terminal on a Linux machine.
2. List all available network interfaces:
   ```bash
   sudo tcpdump -D
   ```
   - This displays a numbered list of interfaces you can monitor.
3. Start capturing packets on a specific interface (e.g., `eth0`):
   ```bash
   sudo tcpdump -i eth0
   ```
   - Press `Ctrl+C` to stop capturing packets.
4. Learn more about the `tcpdump` options from the [tcpdump introduction guide](https://opensource.com/article/18/10/introduction-tcpdump).

### **Explanation**
- `tcpdump` is a command-line utility for packet capture, similar to `Wireshark`, but without a graphical interface. It displays real-time packet headers for analysis.

---

## **Exercise 2: Capturing Packets with tcpdump**

### **Objective**
Capture ICMP packets between two virtual machines using `tcpdump`.

### **Steps**
1. Launch both VMs (VM1 and VM2) in VirtualBox.
2. Open three PuTTY sessions:
   - Two sessions connected to **VM2**.
   - One session connected to **VM1**.

#### **On VM2 (Session 1):**
1. Run the following `tcpdump` command to capture ICMP packets:
   ```bash
   sudo tcpdump -i eth1 -c 10 icmp -n -w 0001.pcap
   ```
   - **Options**:
     - `-i eth1`: Specifies the interface to monitor.
     - `-c 10`: Captures only 10 packets.
     - `icmp`: Filters only ICMP packets (e.g., generated by `ping`).
     - `-n`: Disables DNS resolution for performance.
     - `-w 0001.pcap`: Saves the captured packets to a file named `0001.pcap`.

#### **On VM2 (Session 2):**
1. Generate ICMP traffic by pinging VM1:
   ```bash
   ping 192.168.1.11
   ```
   - Replace `192.168.1.11` with the actual IP address of VM1.
2. Monitor the output of the first session on VM2. Once 10 packets are captured, `tcpdump` will stop automatically, and a confirmation message will appear.

### **Explanation**
- ICMP packets, generated by the `ping` command, are captured and saved in a `.pcap` file for further analysis in Wireshark.

---

## **Exercise 3: Viewing the .pcap File in Wireshark**

### **Objective**
Analyze the captured `.pcap` file using Wireshark to explore TCP communication fields.

### **Steps**
1. Transfer the `.pcap` file (`0001.pcap`) from VM2 to your local machine:
   - Use **WinSCP** to connect to VM2.
   - Navigate to the directory containing `0001.pcap`.
   - Download the file to a folder on your local machine.
2. Open Wireshark on your local machine.
3. Load the `.pcap` file:
   - Go to **File > Open** and select the `0001.pcap` file.
4. Analyze the captured packets:
   - The **Top Pane** shows a summary of each captured packet.
   - The **Middle Pane** displays encapsulated protocol headers (TCP, IP, Ethernet).
   - The **Bottom Pane** shows raw data in hexadecimal and ASCII formats.

### **Questions and Answers**
1. **What are the source and destination IP addresses?**
   - The source is the IP of the VM initiating the `ping`.
   - The destination is the IP of the responding VM.
2. **What ICMP types and codes are observed?**
   - ICMP Type 8: Echo Request.
   - ICMP Type 0: Echo Reply.
3. **Are there any retransmissions or anomalies in the sequence numbers?**
   - Analyze the sequence and acknowledgment numbers for irregularities.

---

## **Key Fields to Explore in TCP Packets**
1. **Sequence (Seq) Numbers**:
   - Identify the order of packets sent.
2. **Acknowledgment (Ack) Numbers**:
   - Verify successful packet delivery.
3. **Window (Win) Size**:
   - Understand flow control in the communication.

---

## **Complete Commands Used**

### **Command List**
1. List all available interfaces:
   ```bash
   sudo tcpdump -D
   ```
2. Capture ICMP packets:
   ```bash
   sudo tcpdump -i eth1 -c 10 icmp -n -w 0001.pcap
   ```
3. Generate ICMP traffic:
   ```bash
   ping <IP_ADDRESS>
   ```
4. Transfer `.pcap` file to the local machine:
   - Use **WinSCP** or a similar file transfer tool.

---

## **Troubleshooting**
- Ensure correct network configurations for VMs in VirtualBox.
- Verify interfaces using:
  ```bash
  ifconfig
  ```
  or
  ```bash
  ip addr
  ```
- Run `tcpdump` with `sudo` to avoid permission errors.

---

## **Ethical Considerations**
- Perform packet captures only on networks you own or have permission to monitor.
- Avoid capturing sensitive or private data without explicit consent.

---

## **Conclusion**
This lab enhances your understanding of packet capture and analysis tools like `tcpdump` and `Wireshark`. By exploring TCP fields such as **Seq**, **Ack**, and **Win**, you gain insights into the mechanisms of TCP communication.